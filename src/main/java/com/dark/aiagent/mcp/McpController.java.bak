package com.zhuchl.ailangchain4j.mcp;

import java.io.IOException;
import java.util.List;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;

import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;

// 1. å®šä¹‰ç®€å•çš„ DTO ç”¨äºæ¥æ”¶å’Œå‘é€ JSON-RPC
record JsonRpcRequest(String jsonrpc, Object id, String method, Map<String, Object> params) {
}

record JsonRpcResponse(String jsonrpc, Object id, Object result) {
}

@RestController
@RequestMapping("/mcp")
public class McpController {

    // å­˜å‚¨ä¼šè¯ï¼ŒKey æ˜¯ SessionID
    private final Map<String, SseEmitter> emitters = new ConcurrentHashMap<>();

    /**
     * ç¬¬ä¸€æ­¥ï¼šSSE æ¡æ‰‹ç«¯ç‚¹
     * Python Client è¿æ¥è¿™é‡Œå»ºç«‹é•¿è¿æ¥
     */
    @GetMapping(path = "/sse", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public SseEmitter subscribe() {
        SseEmitter emitter = new SseEmitter(Long.MAX_VALUE); // æ— é™è¶…æ—¶
        String sessionId = UUID.randomUUID().toString();

        emitters.put(sessionId, emitter);

        // æ¸…ç†å›è°ƒ
        Runnable cleanup = () -> {
            emitters.remove(sessionId);
            System.out.println("âŒ è¿æ¥æ–­å¼€: " + sessionId);
        };
        emitter.onCompletion(cleanup);
        emitter.onTimeout(cleanup);
        emitter.onError((e) -> cleanup.run());

        // ğŸ”¥ å…³é”®ç‚¹ï¼šè¿æ¥å»ºç«‹åï¼Œç«‹åˆ»å‘ŠçŸ¥ Python å¾€å“ªé‡Œå‘æ¶ˆæ¯
        try {
            // äº‹ä»¶åå¿…é¡»æ˜¯ "endpoint"
            String postEndpoint = "/mcp/messages?sessionId=" + sessionId;
            emitter.send(SseEmitter.event().name("endpoint").data(postEndpoint));
            System.out.println("âœ… Python Client å·²è¿æ¥, Session: " + sessionId);
        } catch (IOException e) {
            emitter.completeWithError(e);
        }

        return emitter;
    }

    /**
     * ç¬¬äºŒæ­¥ï¼šæ¶ˆæ¯å¤„ç†ç«¯ç‚¹
     * Python Client é€šè¿‡ POST å‘é€æŒ‡ä»¤åˆ°è¿™é‡Œ
     */
    @PostMapping("/messages")
    public void handleMessage(@RequestParam String sessionId, @RequestBody JsonRpcRequest request) {
        SseEmitter emitter = emitters.get(sessionId);
        if (emitter == null) {
            System.out.println("âš ï¸ æ”¶åˆ°æ¶ˆæ¯ä½†æ‰¾ä¸åˆ° Session: " + sessionId);
            return;
        }

        try {
            System.out.println("ğŸ“© æ”¶åˆ°æŒ‡ä»¤ [" + request.method() + "] Session: " + sessionId);
            Object result = null;

            // --- 1. å¤„ç†åˆå§‹åŒ– (initialize) ---
            if ("initialize".equals(request.method())) {
                result = Map.of(
                        "protocolVersion", "2024-11-05",
                        "capabilities", Map.of("tools", Map.of()), // å£°æ˜æˆ‘æœ‰å·¥å…·èƒ½åŠ›
                        "serverInfo", Map.of("name", "SpringJavaAgent", "version", "1.0"));
            }

            // --- 2. å¤„ç†å·¥å…·åˆ—è¡¨æŸ¥è¯¢ (tools/list) ---
            else if ("tools/list".equals(request.method())) {
                result = Map.of(
                        "tools", List.of(
                                Map.of(
                                        "name", "query_order",
                                        "description", "æ ¹æ®è®¢å•IDæŸ¥è¯¢çŠ¶æ€",
                                        "inputSchema", Map.of(
                                                "type", "object",
                                                "properties", Map.of(
                                                        "orderId", Map.of("type", "string", "description", "è®¢å•ç¼–å·")),
                                                "required", List.of("orderId")))));
            }

            // --- 3. å¤„ç†å…·ä½“çš„å·¥å…·è°ƒç”¨ (tools/call) ---
            else if ("tools/call".equals(request.method())) {
                String toolName = (String) request.params().get("name");
                Map<String, Object> args = (Map<String, Object>) request.params().get("arguments");

                System.out.println("ğŸ”¨ æ‰§è¡Œå·¥å…·: " + toolName + " å‚æ•°: " + args);

                if ("query_order".equals(toolName)) {
                    String orderId = (String) args.get("orderId");
                    // æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘è¿”å›
                    String businessData = "è®¢å• " + orderId + " çŠ¶æ€æ­£å¸¸ï¼Œå·²å‘è´§ã€‚";

                    // MCP è§„å®šçš„ content ç»“æ„
                    result = Map.of(
                            "content", List.of(
                                    Map.of("type", "text", "text", businessData)));
                } else {
                    throw new RuntimeException("æœªçŸ¥å·¥å…·: " + toolName);
                }
            }

            // --- 4. å¤„ç†åˆå§‹åŒ–å®Œæˆé€šçŸ¥ (notifications/initialized) ---
            else if ("notifications/initialized".equals(request.method())) {
                // è¿™æ˜¯ä¸€ä¸ªé€šçŸ¥ï¼Œä¸éœ€è¦å›æ‰§
                return;
            }

            // --- å‘é€å“åº”å› Python (é€šè¿‡ SSE) ---
            if (request.id() != null) { // åªæœ‰éé€šçŸ¥ç±»çš„è¯·æ±‚æ‰éœ€è¦å›å¤
                JsonRpcResponse response = new JsonRpcResponse("2.0", request.id(), result);

                // äº‹ä»¶åå¿…é¡»æ˜¯ "message"
                emitter.send(SseEmitter.event().name("message").data(response));
            }

        } catch (Exception e) {
            e.printStackTrace();
            // å‘é€é”™è¯¯å›æ‰§ (å¯é€‰)
        }
    }
}